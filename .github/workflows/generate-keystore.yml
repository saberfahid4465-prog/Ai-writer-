name: Generate Signing Keystore

on:
  workflow_dispatch:
    inputs:
      key_alias:
        description: 'Key alias name'
        required: true
        default: 'ai-writer-release'
      store_password:
        description: 'Keystore password'
        required: true
      key_password:
        description: 'Key password'
        required: true
      cn:
        description: 'Common Name (CN)'
        required: true
        default: 'AI Writer'
      org:
        description: 'Organization (O)'
        required: true
        default: 'AI Writer'

jobs:
  generate:
    name: Generate Keystore
    runs-on: ubuntu-latest

    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Generate keystore
        run: |
          keytool -genkeypair \
            -v \
            -keystore upload-keystore.jks \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias "${{ github.event.inputs.key_alias }}" \
            -storepass "${{ github.event.inputs.store_password }}" \
            -keypass "${{ github.event.inputs.key_password }}" \
            -dname "CN=${{ github.event.inputs.cn }}, O=${{ github.event.inputs.org }}, L=Internet, ST=Cloud, C=US"

      - name: Export PEM certificate
        run: |
          keytool -exportcert \
            -alias "${{ github.event.inputs.key_alias }}" \
            -keystore upload-keystore.jks \
            -storepass "${{ github.event.inputs.store_password }}" \
            -rfc \
            -file upload-key.pem

      - name: Generate base64 keystore
        run: |
          base64 -w 0 upload-keystore.jks > keystore-base64.txt
          echo ""
          echo "=============================================="
          echo "  IMPORTANT: Copy the base64 keystore below"
          echo "  and save it as GitHub Secret: KEYSTORE_BASE64"
          echo "=============================================="
          echo ""
          cat keystore-base64.txt
          echo ""

      - name: Show key info
        run: |
          echo "=== Keystore Info ==="
          keytool -list -v -keystore upload-keystore.jks -storepass "${{ github.event.inputs.store_password }}" 2>/dev/null | head -30
          echo ""
          echo "=== SHA1 Fingerprint ==="
          keytool -list -v -keystore upload-keystore.jks -storepass "${{ github.event.inputs.store_password }}" 2>/dev/null | grep SHA1

      - name: Upload keystore files
        uses: actions/upload-artifact@v4
        with:
          name: signing-keystore
          path: |
            upload-keystore.jks
            upload-key.pem
            keystore-base64.txt
          retention-days: 7

      - name: Summary
        run: |
          echo "## Keystore Generated Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Alias | ${{ github.event.inputs.key_alias }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Algorithm | RSA 2048 |" >> $GITHUB_STEP_SUMMARY
          echo "| Validity | 10,000 days |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the **signing-keystore** artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Add **KEYSTORE_BASE64** as a GitHub repository secret (content from keystore-base64.txt)" >> $GITHUB_STEP_SUMMARY
          echo "3. Add **KEYSTORE_PASSWORD** secret = your store password" >> $GITHUB_STEP_SUMMARY
          echo "4. Add **KEY_ALIAS** secret = ${{ github.event.inputs.key_alias }}" >> $GITHUB_STEP_SUMMARY
          echo "5. Add **KEY_PASSWORD** secret = your key password" >> $GITHUB_STEP_SUMMARY
          echo "6. Keep upload-key.pem safe (needed for Play Console upload key reset)" >> $GITHUB_STEP_SUMMARY
