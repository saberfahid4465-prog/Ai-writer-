name: Build Android AAB & APK

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'
  EXPO_SDK: '50'

jobs:
  build:
    name: Build Android Release
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # ─── Checkout ──────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      # ─── Setup Java ────────────────────────────────────
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      # ─── Setup Node.js ─────────────────────────────────
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      # ─── Install dependencies ──────────────────────────
      - name: Install npm dependencies
        run: npm ci

      # ─── Decode keystore ───────────────────────────────
      - name: Decode keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks

      # ─── Setup Android SDK ─────────────────────────────
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # ─── Expo prebuild (generate android project) ──────
      - name: Install Expo CLI
        run: npm install -g expo-cli @expo/ngrok

      - name: Expo prebuild (generate native android)
        run: npx expo prebuild --platform android --clean

      # ─── Configure signing ─────────────────────────────
      - name: Configure release signing
        run: |
          # Create keystore.properties
          cat > android/keystore.properties << EOF
          storeFile=upload-keystore.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF

          # Patch build.gradle to use signing config
          cat >> android/app/build.gradle << 'GRADLE'

          // ─── Release Signing ─────────────────────────
          def keystorePropertiesFile = rootProject.file("keystore.properties")
          def keystoreProperties = new Properties()
          if (keystorePropertiesFile.exists()) {
              keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
          }

          android {
              signingConfigs {
                  release {
                      storeFile file(keystoreProperties['storeFile'] ?: 'upload-keystore.jks')
                      storePassword keystoreProperties['storePassword'] ?: ''
                      keyAlias keystoreProperties['keyAlias'] ?: ''
                      keyPassword keystoreProperties['keyPassword'] ?: ''
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                      minifyEnabled true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
          }
          GRADLE

      # ─── Build AAB ─────────────────────────────────────
      - name: Build Release AAB
        working-directory: android
        run: |
          chmod +x gradlew
          ./gradlew bundleRelease --no-daemon --stacktrace

      # ─── Build APK ─────────────────────────────────────
      - name: Build Release APK
        working-directory: android
        run: |
          ./gradlew assembleRelease --no-daemon --stacktrace

      # ─── Verify outputs ────────────────────────────────
      - name: Verify build outputs
        run: |
          echo "=== AAB ==="
          ls -lh android/app/build/outputs/bundle/release/*.aab || echo "AAB not found"
          echo "=== APK ==="
          ls -lh android/app/build/outputs/apk/release/*.apk || echo "APK not found"

      # ─── Upload AAB artifact ───────────────────────────
      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: android/app/build/outputs/bundle/release/*.aab
          retention-days: 30

      # ─── Upload APK artifact ───────────────────────────
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: android/app/build/outputs/apk/release/*.apk
          retention-days: 30

      # ─── Build summary ─────────────────────────────────
      - name: Build Summary
        run: |
          AAB_SIZE=$(stat -c%s android/app/build/outputs/bundle/release/*.aab 2>/dev/null || echo "0")
          APK_SIZE=$(stat -c%s android/app/build/outputs/apk/release/*.apk 2>/dev/null || echo "0")
          echo "## Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "| Output | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| AAB | $(numfmt --to=iec $AAB_SIZE) |" >> $GITHUB_STEP_SUMMARY
          echo "| APK | $(numfmt --to=iec $APK_SIZE) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from the **Artifacts** section above." >> $GITHUB_STEP_SUMMARY
