name: Build Android App

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: Build Kotlin Release
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ─── Checkout ──────────────────────────────────────
      - name: Checkout code
        uses: actions/checkout@v4

      # ─── JDK 17 ────────────────────────────────────────
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # ─── Gradle ────────────────────────────────────────
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: "8.11.1"

      # ─── Android SDK licences ──────────────────────────
      - name: Accept Android SDK licences
        run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true

      # ─── Build AAB ─────────────────────────────────────
      - name: Build Release AAB
        run: gradle bundleRelease --no-daemon --stacktrace

      # ─── Build APK ─────────────────────────────────────
      - name: Build Release APK
        run: gradle assembleRelease --no-daemon

      # ─── Collect outputs ───────────────────────────────
      - name: Collect build outputs
        run: |
          mkdir -p build-output
          cp app/build/outputs/bundle/release/*.aab build-output/app-release.aab
          cp app/build/outputs/apk/release/*.apk build-output/app-release.apk
          echo "=== Build Outputs ==="
          ls -lh build-output/

      # ─── Upload AAB ───────────────────────────────────
      - name: Upload AAB
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab
          path: build-output/app-release.aab
          retention-days: 90
          if-no-files-found: error

      # ─── Upload APK ───────────────────────────────────
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: build-output/app-release.apk
          retention-days: 90
          if-no-files-found: error

      # ─── Summary ───────────────────────────────────────
      - name: Build Summary
        if: always()
        run: |
          echo "## AI Writer — Native Kotlin Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f build-output/app-release.aab ]; then
            AAB_SIZE=$(stat -c%s build-output/app-release.aab)
            APK_SIZE=$(stat -c%s build-output/app-release.apk 2>/dev/null || echo "0")
            echo "| Output | Size |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
            echo "| AAB | $(numfmt --to=iec $AAB_SIZE) |" >> $GITHUB_STEP_SUMMARY
            echo "| APK | $(numfmt --to=iec $APK_SIZE) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Download AAB and APK from **Artifacts** above." >> $GITHUB_STEP_SUMMARY
          else
            echo "Build failed. Check logs above." >> $GITHUB_STEP_SUMMARY
          fi
